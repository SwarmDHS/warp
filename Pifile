FROM https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2021-05-28/2021-05-07-raspios-buster-armhf-lite.zip

DEPLOY_DIR=deploy

VERSION=unstable

if [[ -v GH_ACTION ]]; then
    VERSION=stable
fi

TO ${DEPLOY_DIR}/warp-${VERSION}-`date +"%Y-%m-%d::%s"`.img

# Increase the image by 300 MB
PUMP 300M

# Enable serial console using built-in configuration tool
RUN raspi-config nonint do_serial 0

# Upgrade the operating system image
RUN apt-get update
RUN apt-get -y dist-upgrade

RUN <<EOF
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | sudo debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | sudo debconf-set-selections
EOF

# Install dependencies
RUN apt install -y \
    hostapd \
    dnsmasq \
    netfilter-persistent \
    iptables-persistent \
    bridge-utils \
    openjdk-11-jre-headless

INSTALL "core" "/usr/core"

printf "Enabling SSH... "
source modules/ssh.sh
echo "Done."

printf "Setting up WiFi... "
source modules/wifi.sh
echo "Done"

printf "Setting locale, keyboard, and timezone... "
source modules/locale.sh
echo "Done"

printf "Setting up bootstrap core..."
source modules/core.sh
echo "Done."

printf "Setting up the access point... "
source modules/accesspt.sh
echo "Done."

RUN echo "Done"