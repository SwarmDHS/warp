FROM https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2021-05-28/2021-05-07-raspios-buster-armhf-lite.zip

DEPLOY_DIR=deploy

VERSION=unstable

if [[ -v GH_ACTION ]]; then
    VERSION=stable
fi

TO ${DEPLOY_DIR}/warp-${VERSION}-`date +"%Y-%m-%d::%s"`.img

# Increase the image by 300 MB
PUMP 300M

# Enable serial console using built-in configuration tool
RUN raspi-config nonint do_serial 0

# Upgrade the operating system image
RUN apt-get update
RUN apt-get -y dist-upgrade

# Take iptables install out of interactive mode
RUN echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
RUN echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections

# Install dependencies
RUN apt install -y \
    hostapd \
    dnsmasq \
    netfilter-persistent \
    iptables-persistent \
    bridge-utils \
    openjdk-11-jre-headless \
    python3-pip

RUN pip3 install flask

INSTALL "core" "/usr/core"

RUN printf "Enabling SSH... "
RUN source modules/ssh.sh
RUN echo "Done."

RUN printf "Setting up WiFi... "
RUN source modules/wifi.sh
RUN echo "Done"

RUN printf "Setting locale, keyboard, and timezone... "
RUN source modules/locale.sh
RUN echo "Done"

RUN printf "Setting up bootstrap core... "
RUN source modules/core.sh
RUN echo "Done"

RUN printf "Setting up the access point... "
RUN source modules/accesspt.sh
RUN echo "Done"

RUN echo "Done"